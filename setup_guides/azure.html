<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Installing Pangeo on Azure &#8212; Pangeo  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/pangeo-style.css?v=0dbad12f" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/example_gallery_styles_patched.css?v=417c3662" />
    <link rel="stylesheet" type="text/css" href="../_static/pangeo-main-site-custom.css?v=91edfa83" />
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=30646c52"></script>
    <script src="../_static/js/jquery-1.11.0.min.js"></script>
    <script src="../_static/js/jquery-fix.js"></script>
    <script src="../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script src="../_static/bootstrap-sphinx.js"></script>
    <link rel="icon" href="../_static/favicon.png"/>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Pangeo Cloud" href="../cloud.html" />
    <link rel="prev" title="Deploying Pangeo in the Cloud" href="cloud.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body>

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
            <span><img src="../_static/small_e_reversed_24px.png"></span>
          Pangeo</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="https://medium.com/pangeo">Blog</a></li>
                <li><a href="https://discourse.pangeo.io">Forum</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about.html">About Pangeo</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../about.html#motivation">Motivation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../about.html#mission-statement">Mission Statement</a></li>
<li class="toctree-l2"><a class="reference internal" href="../about.html#goals">Goals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../about.html#get-involved">Get Involved</a></li>
<li class="toctree-l2"><a class="reference internal" href="../about.html#governance">Governance</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Guide for Scientists</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#learn-about-pangeo-software">Learn About Pangeo Software</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#explore-the-use-cases">Explore the Use Cases</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#try-out-a-pangeo-environment">Try Out a Pangeo Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#give-feedback">Give Feedback</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#contribute-a-use-case">Contribute a Use Case</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#contribute-data">Contribute Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#become-an-open-source-contributor">Become an Open Source Contributor</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../packages.html">Packages</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../packages.html#pangeo-core-packages">Pangeo Core Packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../packages.html#pangeo-affiliated-packages">Pangeo Affiliated Packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../packages.html#guidelines-for-new-packages">Guidelines for New Packages</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../gallery.html">Pangeo Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">Technical Architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#where-we-began">Where we began</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#interoperability-in-pangeo">Interoperability in Pangeo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#software">Software</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#compute-platforms">Compute Platforms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#storage-formats">Storage Formats</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Deployment Setup Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#setting-up-pangeo-on-hpc-systems">Setting up Pangeo on HPC Systems</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#setting-up-pangeo-on-cloud-systems">Setting up Pangeo on Cloud Systems</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../cloud.html">Pangeo Cloud</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../cloud.html#operated-by-2i2c">Operated by 2i2c</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cloud.html#quickstart">Quickstart</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cloud.html#getting-support">Getting Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cloud.html#sign-up">Sign Up</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cloud.html#hubs">Hubs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cloud.html#software-environment">Software Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cloud.html#hardware-environment">Hardware Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cloud.html#files-and-data-in-the-cloud">Files and Data in the Cloud</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cloud.html#dask">Dask</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../data.html">Pangeo and Data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../data.html#data-on-hpc">Data on HPC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data.html#data-in-the-cloud">Data in the Cloud</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../catalog.html">Pangeo Data Catalog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../collaborators.html">Funders and Collaborators</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../collaborators.html#funding-agencies">Funding Agencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../collaborators.html#institutions">Institutions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../collaborators.html#people">People</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../publications.html">Publications</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../publications.html#self-reported">Self-Reported</a></li>
<li class="toctree-l2"><a class="reference internal" href="../publications.html#reporting-form">Reporting Form</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pangeo-showcase.html">Pangeo Showcase</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../pangeo-showcase.html#winter-spring-2024-showcase">Winter/Spring 2024 Showcase</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pangeo-showcase.html#fall-2023-showcase">Fall 2023 Showcase</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pangeo-showcase.html#showcase-archive">Showcase Archive</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../meeting-notes.html">Meeting Schedule and Notes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../meeting-notes.html#community-meeting">Community Meeting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../meeting-notes.html#continental-community-meetings">Continental Community Meetings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../meeting-notes.html#working-group-meetings">Working Group Meetings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../meeting-notes.html#meetings-calendar">Meetings Calendar</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../meetings/index.html">Pangeo Conferences</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../meetings/index.html#past-meetings">Past Meetings</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../roadmap.html">Pangeo Roadmap</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../roadmap.html#supporting-the-pangeo-community">Supporting the Pangeo Community</a></li>
<li class="toctree-l2"><a class="reference internal" href="../roadmap.html#supporting-the-evoloution-of-the-geoscience-software-stack">Supporting the Evoloution of the Geoscience Software Stack</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contact.html">Contact Pangeo</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../contact.html#discourse">Discourse</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contact.html#github">Github</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contact.html#other-media">Other Media</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Installing Pangeo on Azure</a><ul>
<li><a class="reference internal" href="#step-one-build-kubernetes-service">Step One: Build Kubernetes service</a><ul>
<li><a class="reference internal" href="#using-the-web-interface">Using the web interface</a><ul>
<li><a class="reference internal" href="#autoscaling">Autoscaling</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-the-azure-cli">Using the Azure CLI</a><ul>
<li><a class="reference internal" href="#id1">Autoscaling</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#step-two-customise-cluster">Step Two: Customise cluster</a><ul>
<li><a class="reference internal" href="#kubernetes-credentials">Kubernetes credentials</a></li>
<li><a class="reference internal" href="#helm-and-tiller">Helm and tiller</a></li>
</ul>
</li>
<li><a class="reference internal" href="#step-3-install-pangeo">Step 3: Install Pangeo</a><ul>
<li><a class="reference internal" href="#test-install">Test install</a></li>
<li><a class="reference internal" href="#id2">Autoscaling</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="cloud.html" title="Previous Chapter: Deploying Pangeo in the Cloud"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Deploying Pan...</span>
    </a>
  </li>
  <li>
    <a href="../cloud.html" title="Next Chapter: Pangeo Cloud"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Pangeo Cloud &raquo;</span>
    </a>
  </li>
              
            
            
            
            
          </ul>

          
            
            
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li><a class="reference internal" href="#">Installing Pangeo on Azure</a><ul>
<li><a class="reference internal" href="#step-one-build-kubernetes-service">Step One: Build Kubernetes service</a><ul>
<li><a class="reference internal" href="#using-the-web-interface">Using the web interface</a><ul>
<li><a class="reference internal" href="#autoscaling">Autoscaling</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-the-azure-cli">Using the Azure CLI</a><ul>
<li><a class="reference internal" href="#id1">Autoscaling</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#step-two-customise-cluster">Step Two: Customise cluster</a><ul>
<li><a class="reference internal" href="#kubernetes-credentials">Kubernetes credentials</a></li>
<li><a class="reference internal" href="#helm-and-tiller">Helm and tiller</a></li>
</ul>
</li>
<li><a class="reference internal" href="#step-3-install-pangeo">Step 3: Install Pangeo</a><ul>
<li><a class="reference internal" href="#test-install">Test install</a></li>
<li><a class="reference internal" href="#id2">Autoscaling</a></li>
</ul>
</li>
</ul>
</li>
</ul>

<div class="widget navlinks">
  <ul class="this-page-menu">
    <li><a href="https://github.com/pangeo-data/pangeo/blob/master/docs/setup_guides/azure.rst"
            rel="nofollow"
            target="_blank"><span class="fa-stack fa-md"><i class="fa fa-github fa-stack-1x"></i></span> Edit on GitHub</a></li>
  </ul>
</div>
        </div>
      </div>
    <div class="col-md-9 content ">
      
  <section id="installing-pangeo-on-azure">
<h1>Installing Pangeo on Azure<a class="headerlink" href="#installing-pangeo-on-azure" title="Link to this heading">¶</a></h1>
<p>This guide takes you through the steps necessary to install Pangeo on Microsoft’s Azure Cloud Platform.
We’ll make use of Azure’s Kubernetes as a Service offering, called AKS (Azure Kubernetes Service),
for installing Pangeo on Azure.
Documentation on AKS can be found here: <a class="reference external" href="https://docs.microsoft.com/en-gb/azure/aks/">https://docs.microsoft.com/en-gb/azure/aks/</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This guide lays out only the fundamental steps required to install Pangeo on Azure AKS.
Further work, for example to secure your cluster, is highly advised but not directly
covered here.</p>
</div>
<section id="step-one-build-kubernetes-service">
<h2>Step One: Build Kubernetes service<a class="headerlink" href="#step-one-build-kubernetes-service" title="Link to this heading">¶</a></h2>
<p>The first step to installing Pangeo on Azure is to set up a Kubernetes service
that can be used to run Pangeo. This can be done either by using the web interface
or by using the Azure commandline interface (CLI). These are both practical options,
so we’ll cover each one in turn.</p>
<section id="using-the-web-interface">
<h3>Using the web interface<a class="headerlink" href="#using-the-web-interface" title="Link to this heading">¶</a></h3>
<p>To use the Azure web interface you must first have a Microsoft account that you
can use to log into the Azure web interface. If you have an existing Microsoft
account (for example, a hotmail.com or outlook.com email address) then you can use
that, or you can create a new account.</p>
<p>Once you have logged into the Azure web interface, navigate to Kubernetes services
and click the blue Add logo in the top left. This will display the Create Kubernetes cluster
wizard.</p>
<p>Work through the wizard customising the Kubernetes service to be created as you
see necessary (all defaults are reasonable, so you should only need to edit the name
of the Kubernetes service to be created). In the last step before
the cluster is created a validation process is run, ensuring that any customizations you have
made will produce a working cluster. At this step you can also download a
template file to make reproducing or automating cluster creation simpler in the future.</p>
<section id="autoscaling">
<h4>Autoscaling<a class="headerlink" href="#autoscaling" title="Link to this heading">¶</a></h4>
<p>One benefit of the web interface is that we can easily create an AKS resource that implements
autoscaling via virtual nodes (see <a class="reference external" href="https://docs.microsoft.com/en-us/azure/aks/virtual-nodes-portal">https://docs.microsoft.com/en-us/azure/aks/virtual-nodes-portal</a>
for further details on this concept). Virtual nodes are still a preview feature in Azure, so some
limitations currently apply. To enable virtual nodes you need to have followed the setup steps in the
link above and also be using an Azure region where nodes are supported.</p>
<p>With both of these requirements met, you can enable virtual nodes for autoscaling your Kubernetes
service. In the Scale tab, ensure that both the Virtual Nodes and VM scale sets selectors are
set to ‘Enabled’.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You cannot create a Kubernetes service with traditional cluster autoscaling using the
web interface. See the next section for details on using the Azure CLI to create a
Kubernetes service with tradtional cluster autoscaling.</p>
</div>
</section>
</section>
<section id="using-the-azure-cli">
<h3>Using the Azure CLI<a class="headerlink" href="#using-the-azure-cli" title="Link to this heading">¶</a></h3>
<p>Instructions for downloading and installing the Azure CLI on major Operating Systems
can be found at: <a class="reference external" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest</a>.
All interactions with the Azure CLI are via the <code class="docutils literal notranslate"><span class="pre">az</span></code> command.</p>
<p>To create a basic Kubernetes service using the Azure CLI:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>az<span class="w"> </span>aks<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--resource-group<span class="w"> </span><span class="nv">$RESOURCE_GROUP_NAME</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--name<span class="w"> </span><span class="nv">$AKS_RESOURCE_NAME</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--kubernetes-version<span class="w"> </span><span class="m">1</span>.12.6<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--node-count<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--node-vm-size<span class="w"> </span>Standard_B8ms
</pre></div>
</div>
<p>You’ll need to specify a name for your Kubernetes service (as <code class="docutils literal notranslate"><span class="pre">$AKS_RESOURCE_NAME</span></code>) and a
name for an (existing) resource group (as <code class="docutils literal notranslate"><span class="pre">$RESOURCE_GROUP_NAME</span></code>). Note that here
we’ve also asked for a medium-sized VM (that is, <code class="docutils literal notranslate"><span class="pre">Standard_B8ms</span></code>) to host the node
rather than the default. We found that the default node was too small to host all
the pods necessary for the basic Pangeo install created by following this guide.
You can, however, specify any VM size name listed in the links from this page as the value to this key:
<a class="reference external" href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/sizes">https://docs.microsoft.com/en-us/azure/virtual-machines/windows/sizes</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>RBAC (Role-Based Access Control) is enabled by default on Kubernetes services set up using
the Azure CLI. If you need to change this default behaviour, you can specify the
<code class="docutils literal notranslate"><span class="pre">--disable-rbac</span></code> flag when creating your Kubernetes cluster.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">az</span> <span class="pre">aks</span> <span class="pre">create</span></code> command above assumes that you have already set up a resource group
to deploy your Kubernetes service into. If you have not already set up a resource group,
run this command <em>before</em> creating your Kubernetes service:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>az<span class="w"> </span>group<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--name<span class="w"> </span><span class="nv">$RESOURCE_GROUP_NAME</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--location<span class="w"> </span><span class="nv">$RESOURCE_REGION</span><span class="w"> </span><span class="se">\</span>
</pre></div>
</div>
<p>The location of the resource group needs to be specified as a single word
programmatic name for an Azure region. A list of available locations can be found
by running the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>az<span class="w"> </span>account<span class="w"> </span>list-locations<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>name
</pre></div>
</div>
<section id="id1">
<h4>Autoscaling<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h4>
<p>To create a Kubernetes service with autoscaling enabled you can add extra keys
to the previous <code class="docutils literal notranslate"><span class="pre">az</span> <span class="pre">aks</span> <span class="pre">create</span></code> command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>az<span class="w"> </span>aks<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--resource-group<span class="w"> </span><span class="nv">$RESOURCE_GROUP_NAME</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--name<span class="w"> </span><span class="nv">$AKS_RESOURCE_NAME</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--kubernetes-version<span class="w"> </span><span class="m">1</span>.12.6<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--node-count<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--node-vm-size<span class="w"> </span>Standard_B8ms<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--enable-vmss<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--enable-cluster-autoscaler<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--min-count<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--max-count<span class="w"> </span><span class="m">10</span>
</pre></div>
</div>
<p>You can also update an existing Kubernetes service to add autoscaling:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>az<span class="w"> </span>aks<span class="w"> </span>update<span class="w"> </span><span class="se">\</span>
--resource-group<span class="w"> </span><span class="nv">$RESOURCE_GROUP_NAME</span><span class="w"> </span><span class="se">\</span>
--name<span class="w"> </span><span class="nv">$AKS_RESOURCE_NAME</span><span class="w"> </span><span class="se">\</span>
--enable-cluster-autoscaler<span class="w"> </span><span class="se">\</span>
--min-count<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
--max-count<span class="w"> </span><span class="m">3</span>
</pre></div>
</div>
<p>More information on autoscaling with Azure AKS is available here:
<a class="reference external" href="https://docs.microsoft.com/en-gb/azure/aks/cluster-autoscaler">https://docs.microsoft.com/en-gb/azure/aks/cluster-autoscaler</a>.</p>
</section>
</section>
</section>
<section id="step-two-customise-cluster">
<h2>Step Two: Customise cluster<a class="headerlink" href="#step-two-customise-cluster" title="Link to this heading">¶</a></h2>
<p>With a working Kubernetes service now built we can customise it in readiness for installing Pangeo
on the cluster. At its most basic, this means installing helm and tiller, but other
customisations (such as authentication) can also be added at this stage.
The customisations need to be performed using the Azure CLI. If you don’t have the Azure CLI available,
you can either:</p>
<ul class="simple">
<li><p>follow the steps at the link above to install the Azure CLI locally, or</p></li>
<li><p>use the cloud shell built into the web interface
(click the <code class="docutils literal notranslate"><span class="pre">&gt;_</span></code> logo at the right of the blue bar at the top of the web interface).
The cloud shell includes the Azure CLI and a basic implementation of Visual Studio Code editor.</p></li>
</ul>
<section id="kubernetes-credentials">
<h3>Kubernetes credentials<a class="headerlink" href="#kubernetes-credentials" title="Link to this heading">¶</a></h3>
<p>Before we can progress we need to acquire kubernetes credentials for our newly-created
AKS resource:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>az<span class="w"> </span>aks<span class="w"> </span>get-credentials<span class="w"> </span>-g<span class="w"> </span><span class="nv">$RESOURCE_GROUP_NAME</span><span class="w"> </span>-n<span class="w"> </span><span class="nv">$AKS_RESOURCE_NAME</span><span class="w"> </span>--overwrite-existing
</pre></div>
</div>
<p>You will need to provide the name of the AKS resource that you just created (as <code class="docutils literal notranslate"><span class="pre">$AKS_RESOURCE_NAME</span></code>)
and the group within which the resource was created (as <code class="docutils literal notranslate"><span class="pre">$RESOURCE_GROUP_NAME</span></code>).</p>
</section>
<section id="helm-and-tiller">
<h3>Helm and tiller<a class="headerlink" href="#helm-and-tiller" title="Link to this heading">¶</a></h3>
<p>Installing helm and tiller allows us to customise our Kubernetes service by applying
helm charts to it. We need to ensure that helm and tiller will work correctly with
RBAC, which is enabled by default on Azure Kubernetes services.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>helm_rbac.yaml
helm<span class="w"> </span>init<span class="w"> </span>--upgrade<span class="w"> </span>--service-account<span class="w"> </span>tiller<span class="w"> </span>--wait
</pre></div>
</div>
<p>The contents of <code class="docutils literal notranslate"><span class="pre">helm_rbac.yaml</span></code> are as follows:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tiller</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRoleBinding</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tiller</span>
<span class="nt">roleRef</span><span class="p">:</span>
<span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
<span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cluster-admin</span>
<span class="nt">subjects</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tiller</span>
<span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
</pre></div>
</div>
</section>
</section>
<section id="step-3-install-pangeo">
<h2>Step 3: Install Pangeo<a class="headerlink" href="#step-3-install-pangeo" title="Link to this heading">¶</a></h2>
<p>Now we can move onto installing Pangeo on our Kubernetes service. This can be done
as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>pangeo<span class="w"> </span>https://pangeo-data.github.io/helm-chart/
helm<span class="w"> </span>repo<span class="w"> </span>update
helm<span class="w"> </span>upgrade<span class="w"> </span>--install<span class="w"> </span>--namespace<span class="w"> </span>pangeo<span class="w"> </span>pangeo<span class="w"> </span>pangeo/pangeo<span class="w"> </span>-f<span class="w"> </span>pangeo.yaml
</pre></div>
</div>
<p>The helm chart <code class="docutils literal notranslate"><span class="pre">pangeo.yaml</span></code> is the
<a class="reference external" href="https://pangeo-data.github.io/helm-chart/">Pangeo helm chart</a>. The customizations
we made to it are documented in the
<a class="reference external" href="https://zero-to-jupyterhub.readthedocs.io/en/latest/setup-jupyterhub.html">Zero to Jupyterhub</a>
guide.</p>
<section id="test-install">
<h3>Test install<a class="headerlink" href="#test-install" title="Link to this heading">¶</a></h3>
<p>To test that Pangeo has installed successfully on your Kubernetes service, find
the IP address of the Pangeo proxy:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>get<span class="w"> </span>service<span class="w"> </span>proxy-public<span class="w"> </span>--namespace<span class="o">=</span>pangeo
</pre></div>
</div>
<p>Note that this service can take a long time to start up, so you may need to wait
a while for the IP address of the Pangeo proxy to be displayed. The output of the
above command will read <code class="docutils literal notranslate"><span class="pre">&lt;pending&gt;</span></code> while the service is starting up.</p>
<p>Once the service has started up, navigate to the <code class="docutils literal notranslate"><span class="pre">EXTERNAL-IP</span></code> address listed
in the output of the above command in your web browser.
If JupyterHub loads then you have successfully installed Pangeo on your Azure Kubernetes service!</p>
</section>
<section id="id2">
<h3>Autoscaling<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h3>
<p>If you set up your autoscaling Kubernetes service using the cluster autoscaler then autoscaling
should work with no further customisation neeeded. If instead you set up autoscaling using
virtual nodes and VM scale sets then a little more work is needed. In particular we need to
modify the Pangeo <code class="docutils literal notranslate"><span class="pre">worker-template.yaml</span></code> file to add two more key groups to the <code class="docutils literal notranslate"><span class="pre">spec</span></code> section
of the yaml:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">nodeSelector</span><span class="p">:</span>
<span class="w">  </span><span class="nt">kubernetes.io/role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">agent</span>
<span class="w">  </span><span class="nt">beta.kubernetes.io/os</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">virtual-kubelet</span>
<span class="nt">tolerations</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">virtual-kubelet.io/provider</span>
<span class="w">  </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exists</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure.com/aci</span>
<span class="w">  </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NoSchedule</span>
</pre></div>
</div>
</section>
</section>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2018-2023, Pangeo Team.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 7.4.4.<br/>
    </p>
  </div>
</footer>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4K4N4RYC53"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-4K4N4RYC53');
</script>
  </body>
</html>